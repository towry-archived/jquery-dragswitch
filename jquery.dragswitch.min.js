/*! 
 * jQuery plugin that drag switch elements
 * 
 * @copyright 2015 Towry Wang <http://towry.me>
 * @license MIT <http://towry.me/mit-license>
 */
!function(t){function e(t,e){return e=e||function(){},t.length?(o(t,e),t):t}function o(e,n){return this instanceof o?(this.jqr_=e,this.fn_=n,this.dragEndCallbacks=[],this.dragStartCallbacks=[],this.placeholderCallback=null,this.containers=[],this.container=null,this.containerInfo=null,this.containerOut=!0,this.itemOut=!0,this.draggy=null,this.doc=t(document),this.drop=!0,this.moveStarted=!1,this.config=t.fn.dragswitch.defaults,void this.runCallback()):new o(e,n)}function n(t){var e,o;if("relative"===t.css("position"))o=parseInt(t.css("left"),10)||0,e=parseInt(t.css("top"),10)||0;else{var n=t.offset(),i=r(t);o=n.left-i.left,e=n.top-i.top}return{left:o,top:e}}function r(t){return{left:parseInt(t.css("marginLeft"),10)||0,top:parseInt(t.css("marginTop"),10)||0}}t.fn.dragswitch=function(t){if("function"!=typeof t)throw new Error("Argument is not a function");return e(this,t)},t.fn.dragswitch.defaults={handle:"",between:!1};var i="display block float none marginTop 0px marginLeft 0px marginRight 0px marginBottom 0px paddingLeft 0px paddingTop 0px paddingRight 0px paddingBottom 0px".split(" ");o.prototype.runCallback=function(){var t=this.fn_,e=this;t.call(e,this.apiBuilderCallback())},o.prototype.apiBuilderCallback=function(){var e=this;return function(o){o=o||"div","string"==typeof o&&(o=[o]);var n=e.jqr_.selector,r=[];if(n&&(n=n.split(",")),o.length>=n.length)t.each(n,function(t,e){r.push([e,o[t]])});else if(o.length<n.length){var i=o.length;t.each(n,function(t,e){r.push(t>=i?[e,o[i-1]]:[e,o[t]])})}return setTimeout(function(){e.startDrag(r)},0),{dragEnd:function(t){return"function"==typeof t&&e.dragEndCallbacks.push(t),this},dragStart:function(t){return"function"==typeof t&&e.dragStartCallbacks.push(t),this},config:function(o){return e.config=t.extend({},t.fn.dragswitch.defaults,o),this},placeholder:function(t){return"function"==typeof t&&(e.placeholderCallback=t),this}}}},o.prototype.startDrag=function(e){var o,n=(e.length,this.jqr_),r=this;n.each(function(n,i){i=t(i),t.each(e,function(t,e){return i.is(e[0])?(o=e[1],!1):void 0}),o||(o="div");var a=i.children().filter(o);a.css("cursor","pointer"),r.addContainer(i,a)}),r.containers.length<=1&&(r.config.between=!1),r.doc.on("mousedown",function(e){if(1==e.which&&r.drop&&r.container){var o=t(e.target);r.isDragItem(o)&&(r.draggy=o,r.initDraggy(),r.doc.on("mousemove",r.bindMouseMoveHandler()),r.doc.on("mouseup",r.containerMouseUpHandler()))}})},o.prototype.addContainer=function(t,e){var o,n;o=t.offset(),n={dom:t,offset:{left:o.left,top:o.top,right:o.left+t.width(),bottom:o.top+t.height()},child:e,table:[],placeholderIndex:-1},this.containers.push(n),this.buildTableForContainer(n,e),this.bindEventsForContainer(n)};var a,s,c,h;o.prototype.mouseMoveHandler=function(){var t=this;return c=c||function(e){t.drop||(t.config.between&&t.mouseOverWhichContainer(e),t.mouseOverWhichItem(e),t.draggy&&t.draggy.css({left:t.dragPos.left+e.clientX-t.x_+"px",top:t.dragPos.top+e.clientY-t.y_+"px"}))}},o.prototype.mouseOverWhichContainer=function(t){for(var e,o=!0,n=0,r=this.containers.length;r>n;n++){if(e=this.containers[n],t.pageX>=e.offset.left&&t.pageX<=e.offset.right&&t.pageY>=e.offset.top&&t.pageY<=e.offset.bottom){this.containerOut&&(this.container.is(e.dom)||(this.containerInfo.child.length&&(this.containerInfo.placeholder.remove(),this.container.append(this.containerInfo.placeholder),this.containerInfo.placeholderIndex=this.containerInfo.child.length-1),this.updateContainerInfo(!1),this.draggyIndex=-1)),this.container=e.dom,this.containerInfo=e,this.containerOut=!1,o=!0;break}o=!1}o||(this.containerOut===!1,this.containerOut=!0)},o.prototype.mouseOverWhichItem=function(t){if(!this.containerOut){for(var e,o=(this.container,this.containerInfo),n=o.table,r=!1,i=0,a=n.length;a>i;i++){if(e=n[i],t.pageX>=e.offset.left&&t.pageX<=e.offset.right&&t.pageY>=e.offset.top&&t.pageY<=e.offset.bottom){if(e.dom.is(this.draggy))return;this.itemOut&&this.ajustPlaceholderPosition(e),r=!0,this.itemOut=!1;break}r=!1}r||(this.itemOut=!0)}},o.prototype.ajustPlaceholderPosition=function(t){var e=this.containerInfo.placeholder;this.containerInfo.placeholderIndex>t.index?t.dom.before(e):t.dom.after(e),this.containerInfo.placeholderIndex=t.index,this.updateContainerInfo()},o.prototype.updateContainerInfo=function(e){var o=this.containerInfo,n=this.container;e=isNaN(e+1)?!0:e;var r=n.offset();o.offset={left:r.left,top:r.top,right:r.left+n.width(),bottom:r.top+n.height()},-1!==this.draggyIndex&&o.child.splice(this.draggyIndex,1),e&&(o.child.splice(this.containerInfo.placeholderIndex,0,this.draggy.get(0)),this.draggyIndex=this.containerInfo.placeholderIndex);var i,a;o.table=[];for(var s=0,c=o.child.length;c>s;s++)i=t(o.child[s]),a=i.is(this.draggy)?o.placeholder.offset():i.offset(),o.table.push({dom:i,index:s,offset:{left:a.left,top:a.top,right:a.left+i.width(),bottom:a.top+i.height()}})},o.prototype.bindEventsForContainer=function(t){var e,o=this;e=t.dom,a=a||function(t){o.draggy&&o.config.between&&(o.containerOut=!0,o.mouseOverWhichContainer(t))},e.on("mouseout",a),e.on("mousedown",function(t){t.preventDefault(),o.containerOut=!1,o.container=e,o.containerInfo=o.getContainerInfo(e)})},o.prototype.containerMouseUpHandler=function(){var t=this;return h=h||function(){t.doc.off("mouseup",h),t.drop=!0,t.removeMouseMoveHandler(),t.moveStarted&&(t.updateContainerInfo(),t.dropDraggy(),t.clearPlaceholder(),t.restoreDragStyle(),t.config.between&&t.updateEachContainer(),t.draggy=null,t.draggyIndex=null),t.moveStarted=!1;for(var e,o=0,n=t.dragEndCallbacks.length;n>o;o++)e=t.dragEndCallbacks[o],e.call(null)}},o.prototype.restoreDragStyle=function(){var t=this.draggy;t.removeAttr("style"),t.attr("data-orisyl")&&t.attr("style",t.attr("data-orisyl")).removeAttr("data-orisyl")},o.prototype.initDraggy=function(){var t=this.draggy;t.attr("style")&&t.attr("data-orisyl",t.attr("style"))},o.prototype.bindMouseMoveHandler=function(){var t=this;return s=s||function(e){e.stopPropagation(),t.doc.off("mousemove",s),t.doc.on("mousemove",t.mouseMoveHandler()),t.drop=!1,t.moveStarted=!0,t.dragPos=n(t.draggy),t.createPlaceholder(),t.setDragItemPosition(),t.draggy.css("cursor","move"),t.draggy.css("opacity",".6"),t.config.between&&t.updateEachContainer();for(var o,r=0,i=t.dragStartCallbacks.length;i>r;r++)o=t.dragStartCallbacks[r],o.call(null);t.x_=e.clientX,t.y_=e.clientY}},o.prototype.updateEachContainer=function(){for(var t,e,o,n=0,r=this.containers.length;r>n;n++){t=this.containers[n],e=t.dom.offset(),t.offset={left:e.left,top:e.top,right:e.left+t.dom.width(),bottom:e.top+t.dom.height()},o=t.table;for(var i=0,a=o.length;a>i;i++)t=o[i],t.dom.is(this.draggy)||(e=t.dom.offset(),t.offset={left:e.left,top:e.top,right:e.left+t.dom.width(),bottom:e.top+t.dom.height()})}},o.prototype.createPlaceholder=function(){var e;this.containerInfo.placeholder?e=this.containerInfo.placeholder:(e=document.createElement(this.draggy.prop("tagName")),e=t(e),this.containerInfo.placeholder=e),this.containerInfo.placeholderIndex=this.draggyIndex,this.stylePlaceholder(),this.placeholderSetup()},o.prototype.dropDraggy=function(){this.containerInfo.placeholder.before(this.draggy),this.updateContainerInfo()},o.prototype.clearPlaceholder=function(){var t;if(!this.config.between)return t=this.containerInfo.placeholder,void(t&&t.remove());for(var e=0,o=this.containers.length;o>e;e++)t=this.containers[e].placeholder,t&&t.remove()},o.prototype.placeholderSetup=function(){var t,e,o;if(o=this.containerInfo.placeholder,!this.config.between)return void this.draggy.before(o);for(var n=0,r=this.containers.length;r>n;n++)t=this.containers[n],this.container.is(t.dom)||(e=o.clone(),t.dom.append(e),t.placeholder=e,t.placeholderIndex=t.child.length);this.draggy.before(o)},o.prototype.stylePlaceholder=function(){for(var t=this.containerInfo.placeholder,e=this.draggy,o=0,n=i.length;n>o;o+=2)""!==e.css(i[o])&&e.css(i[o])!==i[o+1]&&t.css(i[o],e.css(i[o]));t.css("border","1px dashed #672c4f"),t.css("width",e.css("width")),t.css("height",e.css("height")),e.is("div")||e.css({width:e.css("width"),height:e.css("height")}),this.placeholderCallback&&this.placeholderCallback.call(null,t)},o.prototype.setDragItemPosition=function(){if(this.draggy){var t=n(this.draggy);this.draggy.css({left:t.left+"px",top:t.top+"px",position:"absolute"})}},o.prototype.removeMouseMoveHandler=function(){this.doc.off("mousemove",c),this.doc.off("mousemove",s)},o.prototype.isDragItem=function(t){var e=this.containerInfo;return this.draggyIndex=e.child.index(t),-1!==this.draggyIndex},o.prototype.getContainerInfo=function(t){for(var e=0,o=this.containers.length;o>e;e++)if(this.containers[e].dom.is(t))return this.containers[e]},o.prototype.buildTableForContainer=function(e,o){var n,r=e.table;o.each(function(e,o){o=t(o),n=o.offset(),r.push({dom:o,index:e,offset:{left:n.left,top:n.top,right:n.left+o.width(),bottom:n.top+o.height()}})})}}(jQuery);